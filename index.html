<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementasi Matematis: Group Action D‚ÇÑ‚ãâA‚Çô pada Magic Square</title>
<!-- Load MathJax -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    packages: {'[+]': ['ams']}
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
/* CSS tetap sama */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Courier New', monospace;
  background: #0a192f;
  color: #e6f1ff;
  line-height: 1.6;
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.container {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
  margin-top: 20px;
}

.section {
  background: rgba(17, 34, 64, 0.95);
  border: 1px solid #1e3a5f;
  border-radius: 10px;
  padding: 25px;
  flex: 1;
  min-width: 300px;
}

.section-title {
  color: #64ffda;
  font-size: 1.4rem;
  margin-bottom: 20px;
  border-bottom: 2px solid #64ffda;
  padding-bottom: 8px;
}

.grid-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 500px;
}

.magic-grid {
  display: grid;
  gap: 4px;
  margin: 20px 0;
  padding: 15px;
  background: rgba(10, 25, 47, 0.9);
  border-radius: 8px;
  border: 2px solid #1e3a5f;
}

.cell {
  width: 70px;
  height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #112240;
  border-radius: 6px;
  position: relative;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
}

.cell:hover {
  background: #1a3a6a;
  transform: scale(1.05);
}

.cell.selected {
  background: #64ffda;
  box-shadow: 0 0 15px rgba(100, 255, 218, 0.7);
}

.cell.selected .cell-value {
  color: #0a192f;
  font-weight: bold;
}

.cell.selected .cell-index,
.cell.selected .cell-residue {
  color: #0a192f;
}

.cell-value {
  font-size: 1.4rem;
  color: #e6f1ff;
}

.cell-index {
  position: absolute;
  top: 5px;
  left: 5px;
  font-size: 0.7rem;
  color: #64ffda;
  opacity: 0.8;
}

.cell-residue {
  position: absolute;
  bottom: 5px;
  right: 5px;
  font-size: 0.7rem;
  color: #8892b0;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

button {
  padding: 12px 18px;
  background: #1e3a5f;
  color: #e6f1ff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-family: 'Courier New', monospace;
  font-size: 0.95rem;
  transition: all 0.3s;
  border: 1px solid #2a4a7f;
}

button:hover {
  background: #2a4a7f;
  transform: translateY(-2px);
}

button.primary {
  background: #0a3d62;
  border-color: #1a4d72;
}

button.success {
  background: #1a472a;
  border-color: #2a573a;
}

button.warning {
  background: #5d275d;
  border-color: #6d376d;
}

button.danger {
  background: #8b0000;
  border-color: #9b0000;
}

button.reset {
  background: #ff6b6b;
  border-color: #ff5252;
  color: white;
}

button.info {
  background: #4a6fa5;
  border-color: #5a7fb5;
}

button.cycle-a {
  background: #8a2be2;
  border-color: #9a3bf2;
}

button.cycle-b {
  background: #ff8c00;
  border-color: #ff9c10;
}

button.nonlinear-info {
  background: #9b59b6;
  border-color: #ab69c6;
}

.status-panel {
  background: rgba(100, 255, 218, 0.1);
  border: 1px solid #64ffda;
  border-radius: 8px;
  padding: 20px;
  margin-top: 20px;
}

.formula-box {
  background: rgba(30, 58, 95, 0.8);
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  border-left: 4px solid #64ffda;
}

.math {
  font-size: 1.1rem;
  color: #90e0ef;
}

.verification-results {
  margin-top: 20px;
}

.result-item {
  padding: 10px;
  margin: 8px 0;
  border-radius: 5px;
  background: rgba(255, 255, 255, 0.05);
}

.correct {
  border-left: 4px solid #2ecc71;
  color: #2ecc71;
}

.incorrect {
  border-left: 4px solid #e74c3c;
  color: #e74c3c;
}

.detail {
  margin-left: 20px;
  font-size: 0.9rem;
  opacity: 0.9;
}

.info-text {
  color: #8892b0;
  font-size: 0.9rem;
  margin: 10px 0;
}

.selection-info {
  background: rgba(100, 255, 218, 0.1);
  border: 1px solid #64ffda;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  font-size: 0.9rem;
}

.selection-info h4 {
  color: #64ffda;
  margin-bottom: 8px;
}

.selection-controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.swap-animation {
  animation: swapPulse 0.5s ease-in-out;
}

@keyframes swapPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.cycle-info {
  background: rgba(138, 43, 226, 0.1);
  border: 1px solid #8a2be2;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  font-size: 0.9rem;
  display: none;
}

.cycle-info h4 {
  color: #8a2be2;
  margin-bottom: 8px;
}

.nonlinear-explanation {
  background: rgba(155, 89, 182, 0.1);
  border: 1px solid #9b59b6;
  border-radius: 8px;
  padding: 20px;
  margin-top: 15px;
  font-size: 0.95rem;
  line-height: 1.6;
  display: none;
  max-height: 400px;
  overflow-y: auto;
}

.nonlinear-explanation h4 {
  color: #9b59b6;
  margin-bottom: 15px;
  border-bottom: 2px solid #9b59b6;
  padding-bottom: 8px;
}

.nonlinear-explanation h5 {
  color: #d7bde2;
  margin-top: 15px;
  margin-bottom: 8px;
}

.nonlinear-explanation p {
  margin-bottom: 12px;
}

.nonlinear-explanation ul {
  margin-left: 20px;
  margin-bottom: 15px;
}

.nonlinear-explanation li {
  margin-bottom: 6px;
}

.nonlinear-explanation .highlight {
  background: rgba(155, 89, 182, 0.2);
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #9b59b6;
  margin: 10px 0;
}

.toggle-button {
  margin-top: 10px;
  padding: 8px 15px;
  background: transparent;
  border: 1px solid #9b59b6;
  color: #d7bde2;
  font-size: 0.85rem;
}

.toggle-button:hover {
  background: rgba(155, 89, 182, 0.2);
}

.properties-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-top: 15px;
}

.property-item {
  background: rgba(155, 89, 182, 0.1);
  padding: 12px;
  border-radius: 6px;
  border-left: 3px solid #9b59b6;
}

.property-title {
  color: #9b59b6;
  font-weight: bold;
  margin-bottom: 5px;
}

.permutation-info {
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  font-size: 0.9rem;
  display: none;
}

.permutation-info h4 {
  color: #ffc107;
  margin-bottom: 8px;
}

.permutation-details {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 5px;
}

.order3-cycle-info {
  background: rgba(138, 43, 226, 0.1);
  border: 1px solid #8a2be2;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  font-size: 0.9rem;
  display: none;
}

.order3-cycle-info h4 {
  color: #8a2be2;
  margin-bottom: 8px;
}

/* === Frame teks 3D pejal === */
.conceptual-summary {
  margin: 30px auto;
  padding: 20px 24px;
  max-width: 900px;

  background:
    linear-gradient(
      145deg,
      rgba(30, 41, 59, 0.95),
      rgba(2, 6, 23, 0.95)
    );

  color: #e5e7eb;
  line-height: 1.7;

  border-radius: 14px;
  border: 1px solid rgba(103, 232, 249, 0.35);
  border-left: 5px solid #22d3ee;

  /* Efek frame 3D */
  box-shadow:
    inset 0 1px 0 rgba(255, 255, 255, 0.08),
    inset 0 -2px 6px rgba(0, 0, 0, 0.6),
    0 10px 25px rgba(0, 0, 0, 0.55),
    0 0 0 1px rgba(2, 132, 199, 0.15);

  position: relative;
}

/* Layer bayangan bawah agar tampak "pejal" */
.conceptual-summary::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 14px;
  pointer-events: none;

  box-shadow:
    0 12px 18px rgba(0, 0, 0, 0.45);
}

/* Judul dalam frame */
.conceptual-summary h4 {
  margin-top: 0;
  margin-bottom: 12px;

  color: #67e8f9;
  letter-spacing: 0.6px;

  text-shadow:
    0 1px 0 #020617,
    0 2px 3px rgba(0, 0, 0, 0.8);
}

/* Paragraf supaya terasa solid */
.conceptual-summary p {
  margin: 0;
  text-shadow:
    0 1px 1px rgba(0, 0, 0, 0.55);
}


</style>
</head>
<body>

<h1
style="
    text-align: center; 
    margin-bottom: 30px; 
    color: #60a5fa; 
    font-size: 1.6rem;
    font-weight: bold;
    text-transform: uppercase;
    text-shadow: 
        1px 1px 0px #3b82f6, 
        2px 2px 0px #2563eb, 
        3px 3px 0px #1d4ed8, 
        4px 4px 0px #1e40af,
        5px 5px 10px rgba(0,0,0,0.3);
">
  BiMath: Implementasi Matematis: Tindakan Grup $D_4 \rtimes A‚Çô$  pada Magic Square
</h1>
<div class="conceptual-summary">
  <h4>
  <p align="justify">
  This work represents a successful and synergistic collaboration between
  <b>Bimath</b>, <b>DeepSeek</b>, <b>ChatGPT</b>, and <b>Google Gemini</b>.
  </p>
  </h4>
</div>

<div class="container">
  <!-- Visualisasi Grid -->
  <div class="grid-container section">
    <h2 class="section-title" id="grid-title">Magic Square Orde 3</h2>
    <p id="grid-subtitle" class="info-text">Linear-Modular: m·µ¢‚±º ‚â° 2i + j (mod 3)</p>
    
    <div class="magic-grid" id="magic-grid">
      <!-- Grid akan diisi oleh JavaScript -->
    </div>
    
    <!-- Informasi Permutasi untuk Orde 3 -->
    <div class="order3-cycle-info" id="order3-cycle-info">
      <h4>Permutasi Genap Orde 3</h4>
      <p><strong>a = (1,4,9,6)</strong>: 1‚Üí4‚Üí9‚Üí6‚Üí1</p>
      <p><strong>b = (2,3,8,7)</strong>: 2‚Üí3‚Üí8‚Üí7‚Üí2</p>
      <p class="info-text">Permutasi ini saling asing (disjoint) dan membentuk grup siklik orde 4. Komposisi a‚àòb bertindak pada grid normal menghasilkan persegi ajaib.</p>
    </div>
    
    <!-- Informasi Permutasi untuk Orde 5 -->
    <div class="permutation-info" id="permutation-info">
      <h4>Permutasi x dan y (Ganjil) dan T = xy (Genap)</h4>
      <div class="permutation-details">
        <p><strong>x = (1,2)</strong> (transposisi, ganjil)</p>
        <p><strong>y = (1,2)T</strong> (ganjil, produk transposisi dengan permutasi genap)</p>
        <p><strong>T = (1,11,4,2,18,7,12,6,10,3,25,15,22,24,8,19,14,20,16,23)(5,9,21,17)</strong> (genap)</p>
        <p class="info-text">Paritas: x ganjil, y ganjil, T = xy genap</p>
      </div>
    </div>
    
    <!-- Penjelasan Non-Linear 5x5 -->
    <div class="nonlinear-explanation" id="nonlinear-explanation">
      <h4>‚ú® Magic Square Non-Linear (Associative) $5\times 5$ ‚ú®</h4>
      
      <div class="highlight">
        <p align="justify">
      <strong>Magic square non-linear $5\times5$</strong> ini merepresentasikan 
      <em>persegi ajaib asosiatif</em> yang <b>tidak dihasilkan secara langsung</b> 
      oleh algoritma linear-modular klasik (misalnya metode Siamese), 
      namun tetap mempertahankan keseimbangan matematis sempurna 
      melalui struktur simetri pusat yang kuat.
    </p>
      </div>
      
      <h5>üîó Karakteristik Utama Orde 5</h5>
      <p align="justify">Persegi ini memenuhi seluruh syarat formal sebuah <i>magic square</i>:</p>
  <ul align="justify">
    <li>
      <strong>Jumlah Ajaib (Magic Sum):</strong> 
      Jumlah setiap baris, kolom, dan diagonal utama bernilai tetap
      \[
        M = \frac{5(5^2+1)}{2} = 65.
      \]
    </li>
    <li>
      <strong>Rentang Angka:</strong> 
      Menggunakan tepat himpunan $\{1,2,\dots,25\}$ tanpa pengulangan.
    </li>
  </ul>
      
      <h5>‚ö° Hubungan dengan Metode Siamese (De la Loub√®re)</h5>
  <p align="justify">
    Meskipun tetap valid sebagai persegi ajaib orde ganjil, 
    konstruksi ini <b>bukan hasil langsung</b> dari algoritma Siamese standar:
  </p>
  <ul align="justify">
    <li>
      <strong>Pola Langkah Tidak Uniform:</strong> 
      Tidak mengikuti skema tetap "satu langkah ke atas dan satu ke kanan"
      sebagaimana pada metode Siamese klasik.
    </li>
    <li>
      <strong>Posisi Angka $1$:</strong> 
      Angka $1$ terletak pada sel $(4,2)$, berbeda dari posisi khas Siamese
      yang berada di tengah baris teratas.
    </li>
    <li>
      <strong>Konstruksi Alternatif:</strong> 
      Pola seperti ini dapat diperoleh melalui 
      transformasi simetri, permutasi grup, atau teknik eksploratif
      seperti <i>backtracking</i>, bukan sekadar pengulangan langkah linear.
    </li>
  </ul>
      
      <h5>üéØ Properti Asosiatif (Simetri Pusat)</h5>
  <p align="justify">
    Ciri struktural terpenting dari persegi ini adalah 
    <strong>simetri pusat (associativity)</strong>:
  </p>
  <ul align="justify">
    <li>
      <strong>Pasangan Komplementer:</strong> 
      Untuk setiap sel $(i,j)$ berlaku
      \[
        a_{i,j} + a_{4-i,\,4-j} = 26 = 5^2 + 1.
      \]
    </li>
    <li>
      <strong>Contoh:</strong><br>
      $11 + 15 = 26$, <br>
      $17 + 9 = 26$, <br>
      $25 + 1 = 26$.
    </li>
    <li>
      <strong>Pusat Invarian:</strong> 
      Elemen tengah $13$ pada posisi $(2,2)$ berfungsi sebagai poros simetri
      seluruh matriks.
    </li>
  </ul>

      <h5>üîç Klasifikasi dan Signifikansi Matematis</h5>
  <ul align="justify">
    <li>
      <strong>Associative Magic Square:</strong> 
      Persegi ini termasuk kelas <i>associative (regular) magic squares</i>
      sebagaimana diklasifikasikan dalam literatur klasik (mis. Andrews).
    </li>
    <li>
      <strong>Bukan Pandiagonal:</strong> 
      Tidak semua diagonal pecah (broken diagonals) memiliki jumlah 65.
      Sebab: $18+19+20+16+17=90\neq 65$.
    </li>
    <li>
      <strong>Makna "Non-Linear":</strong> 
      Istilah non-linear di sini merujuk pada 
      <em>metode konstruksi dan pola penempatan</em>,
      bukan pada sifat aljabar elemen matriksnya.
    </li>
  </ul>
      
      <p class="info-text" style="margin-top: 15px; font-style: italic; text-align:justify;">
    "Persegi ini menunjukkan bahwa keteraturan numerik tidak harus muncul dari
    algoritma linear sederhana, melainkan dapat dibangun melalui simetri pusat
    dan permutasi terstruktur yang lebih kaya."
  </p>
    </div>
    
    <div class="selection-info" id="selection-info">
      <h4>Editor Manual</h4>
      <p id="selection-status">Klik dua sel untuk menukar nilainya</p>
      <p class="info-text" id="selection-detail">Sel terpilih: 0</p>
      <div class="selection-controls">
        <button class="info" onclick="clearSelection()">Hapus Pilihan</button>
        <button class="info" onclick="editSelectedCell()" id="edit-button" disabled>Edit Nilai Langsung</button>
        <button class="nonlinear-info" onclick="toggleNonlinearExplanation()" id="explanation-toggle">Tampilkan Penjelasan 5√ó5</button>
      </div>
    </div>
    
    <div class="formula-box">
      <h3>Struktur Matematis</h3>
      <div id="formula-display" class="math">
        <!-- Formula akan diisi oleh JavaScript -->
      </div>
      <div class="info-text">
        <p><strong>i, j</strong> = indeks posisi (0-based)</p>
        <p id="parity-info">Paritas: permutasi a dan b genap, a‚àòb genap</p>
      </div>
    </div>
  </div>
 

 
  <!-- Kontrol dan Status -->
  <div class="section">
    <h2 class="section-title">Kontrol & Analisis</h2>
    
    <div class="controls">
      <!-- Tombol Reset -->
      <div>
        <h3>Reset & Inisialisasi</h3>
        <div class="button-group">
          <button class="reset" onclick="resetToSequential()">Reset ke Grid Normal</button>
          <button class="primary" onclick="resetToExample()">Reset ke Contoh</button>
        </div>
      </div>
      
      <!-- Pilihan Contoh -->
      <div>
        <h3>Pilih Contoh</h3>
        <div class="button-group">
          <button class="primary" onclick="loadExample('linear3')">Linear 3√ó3</button>
          <button class="primary" onclick="loadExample('linear5')">Linear 5√ó5</button>
          <button class="danger" onclick="loadExample('nonlinear5')">Non-Linear 5√ó5 (x,y,T)</button>
        </div>
      </div>
      
      <!-- Kontrol Permutasi untuk Orde 3 -->
      <div id="order3-permutations" style="display: none;">
        <h3>Permutasi Genap Orde 3</h3>
        <div class="button-group">
          <button class="cycle-a" onclick="applyPermutationA()">Permutasi a = (1,4,9,6)</button>
          <button class="cycle-a" onclick="applyPermutationAInverse()">Permutasi a‚Åª¬π = (1,6,9,4)</button>
          <button class="cycle-b" onclick="applyPermutationB()">Permutasi b = (2,3,8,7)</button>
          <button class="cycle-b" onclick="applyPermutationBInverse()">Permutasi b‚Åª¬π = (2,7,8,3)</button>
        </div>
        <div class="button-group">
          <button class="warning" onclick="applyPermutationAB()">Komposisi a‚àòb (dari grid normal)</button>
          <button class="warning" onclick="applyPermutationBA()">Komposisi b‚àòa</button>
          <button class="info" onclick="resetToNormalAndApplyAB()">Dari Grid Normal: a lalu b</button>
        </div>
      </div>
      
      <!-- Kontrol Permutasi untuk Orde 5 -->
      <div id="order5-permutations" style="display: none;">
        <h3>Permutasi x dan y (Ganjil) dan T = xy (Genap)</h3>
        <div class="button-group">
          <button class="cycle-a" onclick="applyPermutationX()">Permutasi x = (1,2) (ganjil)</button>
          <button class="cycle-b" onclick="applyPermutationY()">Permutasi y = (1,2)T (ganjil)</button>
          <button class="success" onclick="applyPermutationT()">Permutasi T (genap)</button>
          <button class="warning" onclick="applyPermutationXY()">Komposisi x lalu y (T)</button>
          <button class="info" onclick="resetToNormalAndApplyXY()">Dari Grid Normal: x lalu y</button>
        </div>
      </div>
      
      <!-- Aksi Grup D‚ÇÑ -->
      <div>
        <h3>Aksi Grup D‚ÇÑ (Simetri Geometri)</h3>
        <div class="button-group">
          <button class="success" onclick="applyD4('rotate90')">Rotasi 90¬∞</button>
          <button class="success" onclick="applyD4('rotate180')">Rotasi 180¬∞</button>
          <button class="success" onclick="applyD4('rotate270')">Rotasi 270¬∞</button>
        </div>
        <div class="button-group">
          <button class="success" onclick="applyD4('reflectH')">Refleksi Horizontal</button>
          <button class="success" onclick="applyD4('reflectV')">Refleksi Vertikal</button>
          <button class="success" onclick="applyD4('reflectD1')">Refleksi Diagonal Utama</button>
          <button class="success" onclick="applyD4('reflectD2')">Refleksi Diagonal Sekunder</button>
        </div>
      </div>
      
      <!-- Aksi Grup A‚Çô -->
      <div>
        <h3>Aksi Grup A‚Çô (Permutasi Aritmetika)</h3>
        <div class="button-group">
          <button class="warning" onclick="applyAn('permuteRows')">Permutasi Baris</button>
          <button class="warning" onclick="applyAn('permuteCols')">Permutasi Kolom</button>
          <button class="warning" onclick="applyAn('cycleIndices')">Siklus Indeks</button>
          <button class="warning" onclick="applyAn('addConstant')">Tambah Konstanta Modular</button>
        </div>
      </div>
      
      <!-- Verifikasi -->
      <div>
        <h3>Verifikasi Matematis</h3>
        <button class="primary" onclick="verifySquare()" style="width: 100%;">
          Verifikasi Semua Properti
        </button>
        <div id="verification-output" class="verification-results"></div>
      </div>
      
      <!-- Status -->
      <div class="status-panel">
        <h3>Status Orbit</h3>
        <p id="orbit-status">Square linear-modular dalam orbit D‚ÇÑ‚ãâA‚Çô</p>
        <p><strong>Orde:</strong> <span id="order-value">3</span></p>
        <p><strong>Jumlah Ajaib:</strong> <span id="magic-sum">15</span></p>
        <p><strong>Mode:</strong> <span id="mode-status">Linear-Modular</span></p>
        <p><strong>Permutasi Terakhir:</strong> <span id="last-permutation">Tidak ada</span></p>
        <p><strong>Kelas Square:</strong> <span id="square-class">Linear-Modular</span></p>
        <p><strong>Paritas:</strong> <span id="parity-status">a dan b genap</span></p>
      </div>
    </div>
  </div>
</div>

<script>
// ===== KONSTANTA DAN DATA =====
const EXAMPLES = {
  linear3: {
    name: "Magic Square Linear-Modular Orde 3",
    order: 3,
    square: [
      [8, 1, 6],
      [3, 5, 7],
      [4, 9, 2]
    ],
    residues: (() => {
      const res = Array(3).fill().map(() => Array(3));
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          res[i][j] = (2*i + j) % 3;
        }
      }
      return res;
    })(),
    formula: "$$m_{ij} \\equiv 2i + j \\pmod{3}$$",
    latex: true,
    params: { a: 2, b: 1, c: 0, n: 3 },
    magicSum: 15,
    mode: "linear",
    squareClass: "Linear-Modular",
    permutationType: "order3"
  },
  
  linear5: {
    name: "Magic Square Linear-Modular Orde 5",
    order: 5,
    square: [
      [17, 24, 1, 8, 15],
      [23, 5, 7, 14, 16],
      [4, 6, 13, 20, 22],
      [10, 12, 19, 21, 3],
      [11, 18, 25, 2, 9]
    ],
    residues: (() => {
      const res = Array(5).fill().map(() => Array(5));
      for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 5; j++) {
          res[i][j] = (1*i + 2*j + 1) % 5;
        }
      }
      return res;
    })(),
    formula: "$$m_{ij} \\equiv i + 2j + 1 \\pmod{5}$$",
    latex: true,
    params: { a: 1, b: 2, c: 1, n: 5 },
    magicSum: 65,
    mode: "linear",
    squareClass: "Linear-Modular",
    permutationType: "order5"
  },
  
  nonlinear5: {
    name: "Magic Square Non-Linear Orde 5 dari x dan y",
    order: 5,
    square: [
      [11, 18, 25, 2, 9],
      [10, 12, 19, 21, 3],
      [4, 6, 13, 20, 22],
      [23, 5, 7, 14, 16],
      [17, 24, 1, 8, 15]
    ],
    residues: null,
    formula: "$$T = xy \\text{ dengan } x, y \\text{ ganjil}$$",
    latex: true,
    params: null,
    magicSum: 65,
    mode: "nonlinear",
    squareClass: "Non-Linear (Pan-Non Linear Ajaib)",
    permutationType: "order5"
  }
};

// Grid normal untuk orde 3 dan 5
const NORMAL_GRIDS = {
  3: [
    [1, 2, 3],
    [4, 5, 6],
    [7, 8, 9]
  ],
  5: [
    [1, 2, 3, 4, 5],
    [6, 7, 8, 9, 10],
    [11, 12, 13, 14, 15],
    [16, 17, 18, 19, 20],
    [21, 22, 23, 24, 25]
  ]
};

// ===== DEFINISI PERMUTASI =====

// Permutasi untuk orde 3
const PERMUTATIONS_3 = {
  a: {1: 4, 4: 9, 9: 6, 6: 1}, // (1,4,9,6)
  a_inverse: {1: 6, 6: 9, 9: 4, 4: 1}, // (1,6,9,4)
  b: {2: 3, 3: 8, 8: 7, 7: 2}, // (2,3,8,7)
  b_inverse: {2: 7, 7: 8, 8: 3, 3: 2}, // (2,7,8,3)
  
  // Komposisi a‚àòb
  ab: function() {
    const mapping = {};
    for (let i = 1; i <= 9; i++) {
      let val = i;
      if (this.b[val]) val = this.b[val];
      if (this.a[val]) val = this.a[val];
      if (val !== i) mapping[i] = val;
    }
    return mapping;
  },
  
  // Komposisi b‚àòa
  ba: function() {
    const mapping = {};
    for (let i = 1; i <= 9; i++) {
      let val = i;
      if (this.a[val]) val = this.a[val];
      if (this.b[val]) val = this.b[val];
      if (val !== i) mapping[i] = val;
    }
    return mapping;
  }
};

// Permutasi untuk orde 5
const PERMUTATIONS_5 = {
  // Permutasi T (genap) yang menghasilkan persegi ajaib
  T: {
    1: 11, 2: 18, 3: 25, 4: 2, 5: 9,
    6: 10, 7: 12, 8: 19, 9: 21, 10: 3,
    11: 4, 12: 6, 13: 13, 14: 20, 15: 22,
    16: 23, 17: 5, 18: 7, 19: 14, 20: 16,
    21: 17, 22: 24, 23: 1, 24: 8, 25: 15
  },
  
  // Permutasi x (ganjil) = (1,2) transposisi
  x: {
    1: 2, 2: 1, 3: 3, 4: 4, 5: 5,
    6: 6, 7: 7, 8: 8, 9: 9, 10: 10,
    11: 11, 12: 12, 13: 13, 14: 14, 15: 15,
    16: 16, 17: 17, 18: 18, 19: 19, 20: 20,
    21: 21, 22: 22, 23: 23, 24: 24, 25: 25
  },
  
  // Permutasi y (ganjil) = (1,2) ‚àò T
  y: {
    1: 18, 2: 11, 3: 25, 4: 2, 5: 9,
    6: 10, 7: 12, 8: 19, 9: 21, 10: 3,
    11: 4, 12: 6, 13: 13, 14: 20, 15: 22,
    16: 23, 17: 5, 18: 7, 19: 14, 20: 16,
    21: 17, 22: 24, 23: 1, 24: 8, 25: 15
  }
};

// ===== STATE GLOBAL =====
let current = {
  square: [],
  residues: null,
  order: 3,
  magicSum: 15,
  mode: "linear",
  formula: "",
  latex: true,
  params: null,
  currentExampleKey: "linear3",
  lastPermutation: "Tidak ada",
  squareClass: "Linear-Modular",
  parity: "a dan b genap"
};

// ===== STATE UNTUK SELEKSI SEL =====
let selectedCells = [];

// ===== VARIABEL UNTUK PENJELASAN NON-LINEAR =====
let nonlinearExplanationVisible = false;

// ===== FUNGSI UTAMA =====
function init() {
  loadExample('linear3');
}

function loadExample(exampleKey) {
  const ex = EXAMPLES[exampleKey];
  current.square = ex.square.map(row => [...row]);
  current.residues = ex.residues ? ex.residues.map(row => [...row]) : null;
  current.order = ex.order;
  current.magicSum = ex.magicSum;
  current.mode = ex.mode;
  current.formula = ex.formula;
  current.latex = ex.latex;
  current.params = ex.params;
  current.currentExampleKey = exampleKey;
  current.lastPermutation = "Tidak ada";
  current.squareClass = ex.squareClass;
  
  // Setel paritas berdasarkan contoh
  if (ex.permutationType === "order3") {
    current.parity = "a dan b genap";
  } else if (ex.permutationType === "order5") {
    if (ex.mode === "nonlinear") {
      current.parity = "x dan y ganjil, T genap";
    } else {
      current.parity = "Linear (tidak ada permutasi khusus)";
    }
  }
  
  // Tampilkan/sembunyikan kontrol yang sesuai
  togglePermutationControls();
  clearSelection();
  renderGrid();
  updateStatus();
  
  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

function togglePermutationControls() {
  const order3Section = document.getElementById('order3-permutations');
  const order5Section = document.getElementById('order5-permutations');
  const order3Info = document.getElementById('order3-cycle-info');
  const order5Info = document.getElementById('permutation-info');
  const explanationToggle = document.getElementById('explanation-toggle');
  const nonlinearExplanation = document.getElementById('nonlinear-explanation');
  
  if (current.order === 3) {
    order3Section.style.display = 'block';
    order5Section.style.display = 'none';
    order3Info.style.display = 'block';
    order5Info.style.display = 'none';
    explanationToggle.style.display = 'none';
    nonlinearExplanation.style.display = 'none';
    nonlinearExplanationVisible = false;
  } else if (current.order === 5) {
    order3Section.style.display = 'none';
    order5Section.style.display = 'block';
    order3Info.style.display = 'none';
    order5Info.style.display = 'block';
    
    if (current.mode === 'nonlinear') {
      explanationToggle.style.display = 'inline-block';
      explanationToggle.textContent = 'Tampilkan Penjelasan 5√ó5';
      nonlinearExplanation.style.display = 'none';
      nonlinearExplanationVisible = false;
    } else {
      explanationToggle.style.display = 'none';
      nonlinearExplanation.style.display = 'none';
      nonlinearExplanationVisible = false;
    }
  } else {
    order3Section.style.display = 'none';
    order5Section.style.display = 'none';
    order3Info.style.display = 'none';
    order5Info.style.display = 'none';
    explanationToggle.style.display = 'none';
    nonlinearExplanation.style.display = 'none';
    nonlinearExplanationVisible = false;
  }
  
  // Update info paritas
  document.getElementById('parity-info').textContent = `Paritas: ${current.parity}`;
}

function resetToSequential() {
  const n = current.order;
  current.square = NORMAL_GRIDS[n].map(row => [...row]);
  current.residues = null;
  current.mode = "sequential";
  current.formula = `Grid normal 1 sampai ${n*n}`;
  current.latex = false;
  current.magicSum = null;
  current.lastPermutation = "Tidak ada";
  current.squareClass = "Grid Normal";
  current.parity = "Tidak berlaku";
  
  togglePermutationControls();
  clearSelection();
  renderGrid();
  updateStatus();
}

function resetToExample() {
  loadExample(current.currentExampleKey);
}

function toggleNonlinearExplanation() {
  const explanationBox = document.getElementById('nonlinear-explanation');
  const toggleButton = document.getElementById('explanation-toggle');
  
  if (!explanationBox) {
    console.error('Elemen nonlinear-explanation tidak ditemukan');
    return;
  }
  
  nonlinearExplanationVisible = !nonlinearExplanationVisible;
  
  if (nonlinearExplanationVisible) {
    explanationBox.style.display = 'block';
    toggleButton.textContent = 'Sembunyikan Penjelasan 5√ó5';
    
    // Scroll ke penjelasan jika perlu
    explanationBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } else {
    explanationBox.style.display = 'none';
    toggleButton.textContent = 'Tampilkan Penjelasan 5√ó5';
  }
}

// ===== FUNGSI RENDER GRID =====
function renderGrid() {
  const grid = document.getElementById('magic-grid');
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${current.order}, 1fr)`;
  
  for (let i = 0; i < current.order; i++) {
    for (let j = 0; j < current.order; j++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.row = i;
      cell.dataset.col = j;
      
      const isSelected = selectedCells.some(cellPos => 
        cellPos.row === i && cellPos.col === j
      );
      if (isSelected) {
        cell.classList.add('selected');
      }
      
      cell.addEventListener('click', () => handleCellClick(i, j));
      
      const valueSpan = document.createElement('div');
      valueSpan.className = 'cell-value';
      valueSpan.textContent = current.square[i][j];
      
      const indexSpan = document.createElement('div');
      indexSpan.className = 'cell-index';
      indexSpan.textContent = `(${i},${j})`;
      
      const residueSpan = document.createElement('div');
      residueSpan.className = 'cell-residue';
      if (current.mode === 'linear' && current.residues) {
        residueSpan.textContent = `r=${current.residues[i][j]}`;
      } else if (current.mode === 'sequential') {
        residueSpan.textContent = 'normal';
      } else if (current.mode === 'nonlinear') {
        residueSpan.textContent = 'non-lin';
      } else {
        residueSpan.textContent = 'modif';
      }
      
      cell.appendChild(valueSpan);
      cell.appendChild(indexSpan);
      cell.appendChild(residueSpan);
      
      if (i === j || i + j === current.order - 1) {
        cell.style.background = isSelected ? '#64ffda' : 'rgba(100, 255, 218, 0.15)';
      }
      
      grid.appendChild(cell);
    }
  }
  
  document.getElementById('grid-title').textContent = 
    current.mode === 'linear' 
      ? `Magic Square Linear-Modular Orde ${current.order}`
      : current.mode === 'sequential'
      ? `Grid Normal Orde ${current.order}`
      : current.mode === 'nonlinear'
      ? `Magic Square Non-Linear Orde ${current.order} (dari x dan y)`
      : `Square Orde ${current.order} (Dimodifikasi)`;
  
  const formulaDisplay = document.getElementById('formula-display');
  formulaDisplay.innerHTML = '';
  
  if (current.latex) {
    formulaDisplay.innerHTML = current.formula;
    formulaDisplay.className = 'math';
  } else {
    formulaDisplay.textContent = current.formula;
    formulaDisplay.className = 'math';
    formulaDisplay.style.color = '#90e0ef';
  }
  
  const subtitle = document.getElementById('grid-subtitle');
  if (current.mode === 'linear') {
    subtitle.textContent = `Linear-Modular: m·µ¢‚±º ‚â° ${current.params.a}i + ${current.params.b}j + ${current.params.c} (mod ${current.params.n})`;
  } else if (current.mode === 'sequential') {
    subtitle.textContent = current.formula;
  } else if (current.mode === 'nonlinear') {
    subtitle.textContent = "Non-linear: Dibangun dari dua permutasi ganjil x dan y (T = xy genap)";
  } else {
    subtitle.textContent = current.formula;
  }
  
  updateSelectionStatus();
}

function handleCellClick(row, col) {
  const index = selectedCells.findIndex(cell => 
    cell.row === row && cell.col === col
  );
  
  if (index !== -1) {
    // Jika sel sudah terpilih, hapus dari seleksi
    selectedCells.splice(index, 1);
    renderGrid();
    updateSelectionStatus();
  } else {
    if (selectedCells.length < 2) {
      selectedCells.push({ row, col });
      
      // Jika setelah menambahkan, kita memiliki 2 sel terpilih, lakukan pertukaran otomatis
      if (selectedCells.length === 2) {
        // Tunggu sebentar agar user bisa melihat sel mana yang dipilih
        setTimeout(() => {
          performSwap();
        }, 300);
      }
      
      renderGrid();
      updateSelectionStatus();
    } else {
      // Jika sudah ada 2 sel terpilih, ganti seleksi dengan menghapus yang pertama dan menambah yang baru
      selectedCells.shift();
      selectedCells.push({ row, col });
      renderGrid();
      updateSelectionStatus();
    }
  }
}

function performSwap() {
  if (selectedCells.length !== 2) {
    return;
  }
  
  const [cell1, cell2] = selectedCells;
  
  // Pastikan kedua sel berbeda
  if (cell1.row === cell2.row && cell1.col === cell2.col) {
    clearSelection();
    return;
  }
  
  // Lakukan pertukaran
  const temp = current.square[cell1.row][cell1.col];
  current.square[cell1.row][cell1.col] = current.square[cell2.row][cell2.col];
  current.square[cell2.row][cell2.col] = temp;
  
  if (current.residues) {
    const tempRes = current.residues[cell1.row][cell1.col];
    current.residues[cell1.row][cell1.col] = current.residues[cell2.row][cell2.col];
    current.residues[cell2.row][cell2.col] = tempRes;
  }
  
  current.mode = 'manual';
  current.formula = 'Square yang dimodifikasi manual';
  current.latex = false;
  current.squareClass = 'Dimodifikasi Manual';
  current.parity = 'Tidak diketahui';
  
  // Beri animasi pada grid
  const grid = document.getElementById('magic-grid');
  grid.classList.add('swap-animation');
  setTimeout(() => {
    grid.classList.remove('swap-animation');
  }, 500);
  
  // Kosongkan seleksi setelah pertukaran
  clearSelection();
  
  // Update status
  updateStatus();
}

function updateSelectionStatus() {
  const selectionStatus = document.getElementById('selection-status');
  const selectionDetail = document.getElementById('selection-detail');
  const editButton = document.getElementById('edit-button');
  
  if (selectedCells.length === 0) {
    selectionStatus.textContent = 'Klik dua sel untuk menukar nilainya';
    selectionDetail.textContent = 'Sel terpilih: 0';
    editButton.disabled = true;
  } else if (selectedCells.length === 1) {
    const cell = selectedCells[0];
    const value = current.square[cell.row][cell.col];
    selectionStatus.textContent = 'Klik sel kedua untuk menukar nilai';
    selectionDetail.textContent = `Sel terpilih: 1 (${cell.row},${cell.col}) = ${value}`;
    editButton.disabled = false;
  } else {
    const cell1 = selectedCells[0];
    const cell2 = selectedCells[1];
    const value1 = current.square[cell1.row][cell1.col];
    const value2 = current.square[cell2.row][cell2.col];
    
    selectionStatus.textContent = 'Menukar nilai secara otomatis...';
    selectionDetail.textContent = `Menukar: (${cell1.row},${cell1.col}) = ${value1} ‚Üî (${cell2.row},${cell2.col}) = ${value2}`;
    editButton.disabled = true;
  }
}

function clearSelection() {
  selectedCells = [];
  renderGrid();
}

function editSelectedCell() {
  if (selectedCells.length === 0) {
    alert('Pilih satu sel untuk diedit');
    return;
  }
  
  const cell = selectedCells[0];
  const currentValue = current.square[cell.row][cell.col];
  const maxValue = current.order * current.order;
  
  const newValue = prompt(`Edit nilai sel (${cell.row},${cell.col}):\nNilai saat ini: ${currentValue}\nRentang: 1-${maxValue}`, currentValue);
  
  if (newValue !== null) {
    const numValue = parseInt(newValue);
    if (isNaN(numValue) || numValue < 1 || numValue > maxValue) {
      alert(`Masukkan angka antara 1 dan ${maxValue}`);
      return;
    }
    
    current.square[cell.row][cell.col] = numValue;
    
    current.mode = 'manual';
    current.formula = 'Square yang dimodifikasi manual';
    current.latex = false;
    current.squareClass = 'Dimodifikasi Manual';
    current.parity = 'Tidak diketahui';
    
    clearSelection();
    
    renderGrid();
    updateStatus();
  }
}

// ===== FUNGSI PERMUTASI ORDE 3 =====
function applyPermutationA() {
  applyPermutationToSquare(PERMUTATIONS_3.a);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi a = (1,4,9,6)';
  current.latex = false;
  current.lastPermutation = 'a (genap)';
  current.squareClass = 'Setelah permutasi a';
  current.parity = 'a genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationAInverse() {
  applyPermutationToSquare(PERMUTATIONS_3.a_inverse);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi a‚Åª¬π = (1,6,9,4)';
  current.latex = false;
  current.lastPermutation = 'a‚Åª¬π (genap)';
  current.squareClass = 'Setelah permutasi a‚Åª¬π';
  current.parity = 'a‚Åª¬π genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationB() {
  applyPermutationToSquare(PERMUTATIONS_3.b);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi b = (2,3,8,7)';
  current.latex = false;
  current.lastPermutation = 'b (genap)';
  current.squareClass = 'Setelah permutasi b';
  current.parity = 'b genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationBInverse() {
  applyPermutationToSquare(PERMUTATIONS_3.b_inverse);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi b‚Åª¬π = (2,7,8,3)';
  current.latex = false;
  current.lastPermutation = 'b‚Åª¬π (genap)';
  current.squareClass = 'Setelah permutasi b‚Åª¬π';
  current.parity = 'b‚Åª¬π genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationAB() {
  // Reset ke grid normal dulu
  current.square = NORMAL_GRIDS[3].map(row => [...row]);
  // Terapkan a lalu b
  applyPermutationToSquare(PERMUTATIONS_3.a);
  applyPermutationToSquare(PERMUTATIONS_3.b);
  
  current.mode = 'linear';
  current.formula = '$$\\text{Komposisi } a \\circ b \\text{ dari grid normal}$$';
  current.latex = true;
  current.lastPermutation = 'a‚àòb (genap)';
  current.squareClass = 'Linear-Modular';
  current.parity = 'a dan b genap, a‚àòb genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
  
  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

function applyPermutationBA() {
  // Reset ke grid normal dulu
  current.square = NORMAL_GRIDS[3].map(row => [...row]);
  // Terapkan b lalu a
  applyPermutationToSquare(PERMUTATIONS_3.b);
  applyPermutationToSquare(PERMUTATIONS_3.a);
  
  current.mode = 'permuted';
  current.formula = 'Komposisi b‚àòa dari grid normal';
  current.latex = false;
  current.lastPermutation = 'b‚àòa (genap)';
  current.squareClass = 'Setelah b‚àòa';
  current.parity = 'b dan a genap, b‚àòa genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function resetToNormalAndApplyAB() {
  resetToSequential();
  applyPermutationAB();
}

// ===== FUNGSI PERMUTASI ORDE 5 =====
function applyPermutationX() {
  applyPermutationToSquare(PERMUTATIONS_5.x);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi x = (1,2) (ganjil)';
  current.latex = false;
  current.lastPermutation = 'x (ganjil)';
  current.squareClass = 'Setelah permutasi x';
  current.parity = 'x ganjil';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationY() {
  applyPermutationToSquare(PERMUTATIONS_5.y);
  current.mode = 'permuted';
  current.formula = 'Setelah permutasi y = (1,2)T (ganjil)';
  current.latex = false;
  current.lastPermutation = 'y (ganjil)';
  current.squareClass = 'Setelah permutasi y';
  current.parity = 'y ganjil';
  
  clearSelection();
  renderGrid();
  updateStatus();
}

function applyPermutationT() {
  applyPermutationToSquare(PERMUTATIONS_5.T);
  current.mode = 'nonlinear';
  current.formula = '$$T = xy \\text{ (genap)}$$';
  current.latex = true;
  current.lastPermutation = 'T (genap)';
  current.squareClass = 'Non-Linear (dari T)';
  current.parity = 'T genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
  
  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

function applyPermutationXY() {
  applyPermutationToSquare(PERMUTATIONS_5.x);
  applyPermutationToSquare(PERMUTATIONS_5.y);
  current.mode = 'nonlinear';
  current.formula = '$$T = xy \\text{ (genap) dari komposisi x lalu y}$$';
  current.latex = true;
  current.lastPermutation = 'x lalu y (T)';
  current.squareClass = 'Non-Linear (dari x dan y)';
  current.parity = 'x dan y ganjil, T genap';
  
  clearSelection();
  renderGrid();
  updateStatus();
  
  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

function resetToNormalAndApplyXY() {
  resetToSequential();
  applyPermutationXY();
}

// ===== FUNGSI BANTU PERMUTASI =====
function applyPermutationToSquare(mapping) {
  const n = current.order;
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      const num = current.square[i][j];
      current.square[i][j] = mapping[num] !== undefined ? mapping[num] : num;
    }
  }
  current.residues = null;
}

// ===== UPDATE STATUS =====
function updateStatus() {
  document.getElementById('order-value').textContent = current.order;
  
  if (current.magicSum) {
    document.getElementById('magic-sum').textContent = current.magicSum;
  } else {
    document.getElementById('magic-sum').textContent = 'N/A';
  }
  
  const modeText = 
    current.mode === 'linear' ? 'Linear-Modular' :
    current.mode === 'sequential' ? 'Grid Normal' :
    current.mode === 'permuted' ? 'Setelah Permutasi' :
    current.mode === 'manual' ? 'Dimodifikasi Manual' :
    current.mode === 'nonlinear' ? 'Non-Linear' :
    'Tidak Diketahui';
  document.getElementById('mode-status').textContent = modeText;
  
  document.getElementById('last-permutation').textContent = current.lastPermutation;
  document.getElementById('square-class').textContent = current.squareClass;
  document.getElementById('parity-status').textContent = current.parity;
  
  const orbitStatus = document.getElementById('orbit-status');
  if (current.mode === 'linear') {
    orbitStatus.textContent = 'Dalam orbit D‚ÇÑ‚ãâA‚Çô';
    orbitStatus.style.color = '#64ffda';
  } else if (current.mode === 'sequential') {
    orbitStatus.textContent = 'Grid normal (bukan persegi ajaib)';
    orbitStatus.style.color = '#ffaa00';
  } else if (current.mode === 'manual') {
    orbitStatus.textContent = 'Dimodifikasi manual - verifikasi diperlukan';
    orbitStatus.style.color = '#ffaa00';
  } else if (current.mode === 'permuted') {
    orbitStatus.textContent = 'Setelah permutasi - verifikasi diperlukan';
    orbitStatus.style.color = '#8a2be2';
  } else if (current.mode === 'nonlinear') {
    orbitStatus.textContent = 'DI LUAR orbit D‚ÇÑ‚ãâA‚Çô - dibangun dari permutasi ganjil';
    orbitStatus.style.color = '#9b59b6';
  } else {
    orbitStatus.textContent = 'Status tidak diketahui';
    orbitStatus.style.color = '#8892b0';
  }
}

// ===== AKSI GRUP D‚ÇÑ dan A‚Çô =====
function applyD4(action) {
  const n = current.order;
  const newSquare = Array.from({ length: n }, () => Array(n));
  const newResidues = current.residues ? 
    Array.from({ length: n }, () => Array(n)) : null;
  
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      let newI, newJ;
      
      switch(action) {
        case 'rotate90':
          newI = j;
          newJ = n - 1 - i;
          break;
        case 'rotate180':
          newI = n - 1 - i;
          newJ = n - 1 - j;
          break;
        case 'rotate270':
          newI = n - 1 - j;
          newJ = i;
          break;
        case 'reflectH':
          newI = n - 1 - i;
          newJ = j;
          break;
        case 'reflectV':
          newI = i;
          newJ = n - 1 - j;
          break;
        case 'reflectD1':
          newI = j;
          newJ = i;
          break;
        case 'reflectD2':
          newI = n - 1 - j;
          newJ = n - 1 - i;
          break;
      }
      
      newSquare[newI][newJ] = current.square[i][j];
      if (newResidues) newResidues[newI][newJ] = current.residues[i][j];
    }
  }
  
  current.square = newSquare;
  current.residues = newResidues;
  
  current.mode = 'manual';
  current.formula = 'Setelah transformasi D‚ÇÑ';
  current.latex = false;
  current.squareClass = 'Setelah Transformasi D‚ÇÑ';
  current.parity = 'Tidak diketahui';
  
  renderGrid();
}

function applyAn(action) {
  const n = current.order;
  
  if (action === 'permuteRows') {
    const firstRow = current.square[0];
    const firstResRow = current.residues ? current.residues[0] : null;
    
    for (let i = 0; i < n - 1; i++) {
      current.square[i] = current.square[i + 1];
      if (current.residues) current.residues[i] = current.residues[i + 1];
    }
    
    current.square[n - 1] = firstRow;
    if (current.residues) current.residues[n - 1] = firstResRow;
  }
  
  else if (action === 'permuteCols') {
    for (let i = 0; i < n; i++) {
      const firstCol = current.square[i][0];
      const firstResCol = current.residues ? current.residues[i][0] : null;
      
      for (let j = 0; j < n - 1; j++) {
        current.square[i][j] = current.square[i][j + 1];
        if (current.residues) current.residues[i][j] = current.residues[i][j + 1];
      }
      
      current.square[i][n - 1] = firstCol;
      if (current.residues) current.residues[i][n - 1] = firstResCol;
    }
  }
  
  else if (action === 'cycleIndices') {
    const newSquare = Array.from({ length: n }, () => Array(n));
    const newResidues = current.residues ? 
      Array.from({ length: n }, () => Array(n)) : null;
    
    for (let i = 0; i < n; i++) {
      for (let j = 0; j < n; j++) {
        const newI = (i + 1) % n;
        const newJ = (j + 1) % n;
        newSquare[newI][newJ] = current.square[i][j];
        if (newResidues) newResidues[newI][newJ] = current.residues[i][j];
      }
    }
    
    current.square = newSquare;
    current.residues = newResidues;
  }
  
  else if (action === 'addConstant') {
    if (current.mode !== 'linear') {
      alert('Hanya berlaku untuk square linear-modular');
      return;
    }
    
    const k = Math.floor(Math.random() * (n * n)) + 1;
    for (let i = 0; i < n; i++) {
      for (let j = 0; j < n; j++) {
        current.square[i][j] = ((current.square[i][j] - 1 + k) % (n * n)) + 1;
      }
    }
  }
  
  current.mode = 'manual';
  current.formula = 'Setelah transformasi A‚Çô';
  current.latex = false;
  current.squareClass = 'Setelah Transformasi A‚Çô';
  current.parity = 'Tidak diketahui';
  
  renderGrid();
}

// ===== VERIFIKASI =====
function verifySquare() {
  const n = current.order;
  const results = [];
  
  let magicSum = current.magicSum;
  if (!magicSum && current.square.length > 0) {
    magicSum = current.square[0].reduce((a, b) => a + b, 0);
  }
  
  if (current.mode === 'linear' || current.mode === 'nonlinear' || current.mode === 'manual' || current.mode === 'permuted') {
    const numbers = new Set();
    for (let i = 0; i < n; i++) {
      for (let j = 0; j < n; j++) {
        numbers.add(current.square[i][j]);
      }
    }
    
    const allNumbersValid = numbers.size === n * n && 
      Math.min(...numbers) === 1 && 
      Math.max(...numbers) === n * n;
    
    results.push({
      text: `Semua angka 1..${n*n} muncul tepat sekali`,
      valid: allNumbersValid,
      details: allNumbersValid ? null : 
        `Ditemukan ${numbers.size} angka unik (harus ${n*n})`
    });
  }
  
  const rowResults = [];
  for (let i = 0; i < n; i++) {
    const sum = current.square[i].reduce((a, b) => a + b, 0);
    rowResults.push({ i, sum, valid: sum === magicSum });
  }
  
  const allRowsValid = rowResults.every(r => r.valid);
  results.push({
    text: `Jumlah semua baris = ${magicSum}`,
    valid: allRowsValid,
    details: !allRowsValid ? 
      rowResults.filter(r => !r.valid)
        .map(r => `Baris ${r.i+1}: ${r.sum} ‚â† ${magicSum}`).join(', ') : null
  });
  
  const colResults = [];
  for (let j = 0; j < n; j++) {
    let sum = 0;
    for (let i = 0; i < n; i++) {
      sum += current.square[i][j];
    }
    colResults.push({ j, sum, valid: sum === magicSum });
  }
  
  const allColsValid = colResults.every(c => c.valid);
  results.push({
    text: `Jumlah semua kolom = ${magicSum}`,
    valid: allColsValid,
    details: !allColsValid ?
      colResults.filter(c => !c.valid)
        .map(c => `Kolom ${c.j+1}: ${c.sum} ‚â† ${magicSum}`).join(', ') : null
  });
  
  let diag1Sum = 0;
  for (let i = 0; i < n; i++) {
    diag1Sum += current.square[i][i];
  }
  const diag1Valid = diag1Sum === magicSum;
  results.push({
    text: `Diagonal utama = ${magicSum}`,
    valid: diag1Valid,
    details: !diag1Valid ? `Didapat: ${diag1Sum} ‚â† ${magicSum}` : null
  });
  
  let diag2Sum = 0;
  for (let i = 0; i < n; i++) {
    diag2Sum += current.square[i][n-1-i];
  }
  const diag2Valid = diag2Sum === magicSum;
  results.push({
    text: `Diagonal sekunder = ${magicSum}`,
    valid: diag2Valid,
    details: !diag2Valid ? `Didapat: ${diag2Sum} ‚â† ${magicSum}` : null
  });
  
  if (current.mode === 'nonlinear' && n === 5) {
    const isPanMagic = checkPanMagic();
    results.push({
      text: `Properti pan-magic (semua broken diagonal berjumlah ${magicSum})`,
      valid: isPanMagic,
      details: !isPanMagic ? 'Tidak semua broken diagonal berjumlah sama' : null
    });
  }
  
  displayResults(results);
}

function checkPanMagic() {
  const n = 5;
  const magicSum = 65;
  
  for (let offset = 0; offset < n; offset++) {
    let sum = 0;
    for (let k = 0; k < n; k++) {
      const i = k;
      const j = (k + offset) % n;
      sum += current.square[i][j];
    }
    if (sum !== magicSum) return false;
  }
  
  for (let offset = 0; offset < n; offset++) {
    let sum = 0;
    for (let k = 0; k < n; k++) {
      const i = (n - 1 - k);
      const j = (k + offset) % n;
      sum += current.square[i][j];
    }
    if (sum !== magicSum) return false;
  }
  
  return true;
}

function displayResults(results) {
  const output = document.getElementById('verification-output');
  let html = '<h4>Hasil Verifikasi Matematis:</h4>';
  
  const allValid = results.every(r => r.valid);
  
  results.forEach(result => {
    const className = result.valid ? 'correct' : 'incorrect';
    const icon = result.valid ? '‚úì' : '‚úó';
    
    html += `
      <div class="result-item ${className}">
        ${icon} ${result.text}
      </div>
    `;
    
    if (result.details) {
      html += `
        <div class="result-item detail">
          ${result.details}
        </div>
      `;
    }
  });
  
  html += `
    <div class="result-item ${allValid ? 'correct' : 'incorrect'}" 
         style="margin-top: 15px; font-weight: bold;">
      ${allValid ? '‚úÖ SEMUA PROPERTI TERPENUHI' : '‚ùå ADA PROPERTI YANG GAGAL'}
    </div>
  `;
  
  output.innerHTML = html;
}

// ===== INISIALISASI =====
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
